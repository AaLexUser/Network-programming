# 10. Что такое идемпотентность? Как реализовать такое API? Области применения

```{glossary}
Идемпотентность
    свойство объекта или операции при повторном применении операции к объекту давать тот же результат, что и при первом. {cite}`Wiki2006Apr`

Идемпотентный API метод
    это такой метод API, повторный вызов которого не меняет состояние. Здесь есть тонкий момент: результат идемпотентного вызова может меняться (Например: `200 Success` - первое, `409 Conflict` - повторные). {cite}`Habr2021Dec` 
```

## Как реализовать идемпотентное API

**Используйте идемпотентные ключи (Idempotency Keys)**

- Когда клиент отправляет запрос на создание или обновление какой-то сущности, он может генерировать уникальный идентификатор запроса (ключ идемпотентности).
- Сервер хранит историю запросов с этим ключом. Если приходит второй запрос с тем же ключом, сервер понимает, что это повтор, и возвращает тот же ответ, что вернул при первом запросе.

Пример

```json
{
  "from": "Москва, ул. Садовническая набережная 82с2",
  "to": "Аэропорт Внуково",
  "idempotency_key": "786706b8-ed80-443a-80f6-ea1fa8cc1b51"
}
```

## Области применения идемпотентности
1. **Финансовые транзакции:**
    В платежных системах важно, чтобы повторные запросы на списание средств не приводили к многократному списанию.
2. **Распределенные системы:**
    В системах с высокой нагрузкой и возможными сбоями сети идемпотентность помогает избежать дублирующих операций.
3. **API для мобильных приложений:**
    Мобильные устройства могут терять соединение, и повторные запросы не должны вызывать побочных эффектов.
4. **Очереди сообщений:**
    В системах, использующих очереди (например, RabbitMQ, Kafka), идемпотентность помогает избежать дублирующей обработки сообщений.
5. **Микросервисы:**
    В архитектуре микросервисов идемпотентность важна для обеспечения согласованности данных между сервисами.

```{bibliography}
:style: unsrt
:filter: docname in docnames
```
